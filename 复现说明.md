
### 数据集修改
`EvSemSeg/datasets/loader_rellis.py`下
~~
```python
# LBL_POSTFIX = 'pylon_camera_node_label_color'
LBL_POSTFIX = 'pylon_camera_node_label_id'
```
~~
回退，上面的修改是错误的。`pylon_camera_node_label_id`子文件和`pylon_camera_node_label_color`根本不是一个东西。

## 路径修改

### 1. 本地ubuntu

`EvSemSeg/datasets/loader_rellis.py`修改
```python
# RELLIS_ROOT = '/data/Rellis-3D'
RELLIS_ROOT = '/home/xzy/datasets/Rellis-3D'
```

但是目前来看，需要24GB显存才能训练，而且需要加载resnet50的预训练权重。

### 2. autodl服务器

配置git账户
```sh
git config user.name "xzy2022"
git config user.email "2889354227@qq.com"

git config --unset user.name
git config --unset user.email
```

解压数据集
```sh
ls /root/autodl-fs
# 00001.7z.001  00001.7z.002

# apt update && apt install p7zip-full -y

7z x /root/autodl-fs/00001.7z.001 -o/root/datasets/Rellis-3D
# ~/datasets/Rellis-3D
```

`EvSemSeg/datasets/loader_rellis.py`修改
```python
# RELLIS_ROOT = '/data/Rellis-3D'
RELLIS_ROOT = '/root/datasets/Rellis-3D'
RELLIS_ROOT = '/root/autodl-tmp/Rellis-3D'
# /root/autodl-tmp 实例关机数据不会丢失，可存放读写IO要求高的数据。但不会随保存镜像一起保存
```

安装依赖
```sh
pip install  pandas
pip install opencv-python-headless==4.5.5.64 -i https://mirrors.aliyun.com/pypi/simple/
```

修改小规模数据集，`EvSemSeg/datasets/loader_rellis.py`
```python
	# "-4": ['00000', '00001', '00002', '00003'],
	"-4": ['00001'],
```

可视化训练曲线
```sh
tensorboard --logdir EvSemSeg/logs_tb/ --host 0.0.0.0 --port 6006
```



## 加载预训练权重


下载预训练权重，如果网络不佳可以从百度网盘获取。
```sh
mkdir pretrained/
cd pretrained/
wget https://download.pytorch.org/models/resnet50-0676ba61.pth
```

运行`scripts/setup_weights.py`以测试预训练的resnet50加载成功。

修改`EvSemSeg/models/unc_seg_models.py`和`EvSemSeg/models/seg_models.py`的`res50`指定预训练模型地址。

## 修改batch_size
修改`EvSemSeg/execute_params.py`的`rellisv3_train`变量：
    batchsize=6
    CUDA_VISIBLE_DEVICES=0
DeeplabV3 里 ASPP 的 全局平均池化分支要求batchsize>=2，所以还得修改。

单卡batch=6时2080 Ti大概是19G显存。
对于双卡2080 Ti，batch=12比较好。
对于单卡4090，batch=8比较极限（23373MiB /  24564MiB）。双卡则设置batch=16。

## 执行训练

```sh
cd EvSemSeg/
python3 execute_params.py --mode ex-train



# 测试权重
python3 execute_params.py --mode ex-test-holdout

# 可视化图像
python3 execute_params.py --mode ex-val-holdout


python3 execute_params.py --mode ex-prep-rellis
```

### 其它选项

`EvSemSeg/execute_params.py`的`rellisv3_train`可以根据参数实现下面功能
```python
# -- load指向你要恢复的 checkpoint，例如
# --load ./ckpts/rellisv3_edl_train-4_temp/50.pth
# --load \'$NONE$\'  表示重新训练
# --save_freq 1 表示每个epoch都保存权重，否则每10轮保存一次（追加而非覆盖）
```

DATA SPLIT 00000 @ 1200 images / 1200 labels found.
DATA SPLIT 00001 @ 1160 images / 1160 labels found.
DATA SPLIT 00002 @ 2073 images / 2073 labels found.
DATA SPLIT 00003 @ 900 images / 900 labels found.
RELLIS-3D Dataset Validity Checked : 5333 image+label pairs found.

在batch=16的情况，一个EPOCH需要5333/16=333个Iter。

Loss/evid_loss：分类准确性的损失，类似于传统的 CrossEntropy Loss，但针对证据分布进行了修改。
Loss/incorrect_reg_loss：这是一个正则化项，用于衡量“我不知道”的程度。
Loss/entire_loss：最终用于反向传播的总损失。

## 数据预处理

### 1. 获取不确定性

修改代码`EvSemSeg/prep.py`

```python 
RELLIS_ROOT = '/root/autodl-tmp/Rellis-3D'
OUTPUT_ROOT = '/root/convertedRellis'
```

### 2. 投影

修改`Projection/rellis_acc_inference.py`的相关路径

```bash
cd Projection
# 语法: python rellis_acc_inference.py {remark} {sequence} {binning_num}
# binning_num=30 意味着每30帧合并成一个文件，用于加速建图
python rellis_acc_inference.py rellisv3_edl_train-4 00004 30
```



输入：（由上游 ex-prep-rellis 生成）

01_inferenced_npy:含义：2D 语义分割模型的原始推理结果。内容：存储了 $(C \times H \times W)$ 维度的 Numpy 数组（.npy），其中 $C$ 是类别数（包含证据值/Logits），$H, W$ 是图像分辨率。用途：提供每个像素的分类证据，用于投影到 3D 点云上。

02_inferenced_vis:含义：2D 推理结果的可视化图像。内容：.jpg 或 .png 图片（通常是原图、不确定性图、预测结果的拼接）。用途：仅供人类目视检查，确保 2D 分割效果正常。

输出（由 rellis_acc_inference.py 生成）：

03_nby3pK_npy:含义：投影并融合后的 3D 语义点云数据（这是最重要的文件夹）。命名解析：nby3pK 代表数据形状为 $N \times (3 + K)$。$N$：点的数量。$3$：坐标 $(x, y, z)$。$K$：$C$ 个类别的证据值/概率。内容：将多帧（根据 binning_num=30）的激光雷达点云与 2D 语义信息融合后的 .npy 文件。用途：作为下一步（数据格式转换）的直接输入。

04_vtk:含义：3D 投影结果的可视化文件。内容：.vtu 或类似格式的文件。用途：可以使用 ParaView 软件打开，直观地查看带有语义颜色的 3D 点云，用于检查投影对齐是否准确（例如路面点是否真的落在路面上）。
`paraview ~/Downloads/convertedRellis/rellisv3_edl_train-4/04_vtk/00004/merged*_frame30.vtu`

05_pVec_pcd:含义：PCD 格式转换目录。状态：目前是空的（只包含子文件夹结构）。用途：它是下一步（运行 roslaunch evsemmap pcd_conversion.launch）的输出目录。该步骤会将 03_nby3pK_npy 中的 Numpy 数据转换为 ROS 和 PCL 库能识别的 .pcd 格式，以便 C++ 建图模块读取。

### 3.ROS编译与格式转换


```bash

# 假设你的代码目录结构是 EvSemMap/SemanticMap/src/SemanticMap
cd ~/EvSemMap/SemanticMap  # 进入包含 src 的父目录
catkin_make                # 编译 ROS 包
source devel/setup.bash    # 刷新环境变量
```

打开 `SemanticMap/src/SemanticMap/launch/pcd_conversion.launch`，修改输入输出路径：

```xml
<launch>
    <arg name="pkg" default="$(find evsemmap)" />
    <node pkg="evsemmap" type="pcd_conversion" name="pcd_conversion" output="screen">        
        <param name="convert_mode_to_my_extension" value="true" />

        <param name="scan_start" value="1" />   
        <param name="scan_num" value="30" />   

        <param name="out_path" value="/home/xzy/Downloads/convertedRellis/rellisv3_edl_train-4/05_pVec_pcd/00004/" />
        <param name="dir" value="/home/xzy/Downloads/convertedRellis/rellisv3_edl_train-4/03_nby3pK_npy/00004/" />

    </node>
</launch>
```
修改后执行
```bash
roslaunch evsemmap pcd_conversion.launch
```

### 4. 地图构建

打开 `SemanticMap/src/SemanticMap/config/datasets/deploy_rellisv3_4_1-30.yaml`，这是核心配置文件。

```yaml
# 修改输入目录，指向你刚刚生成的 pcd 文件夹
dir: /home/xzy/Downloads/convertedRellis/rellisv3_edl_train-4/05_pVec_pcd/00004/

# 确保 scan_num 与转换阶段一致
scan_num: 30 
```

这里我们使用论文推荐的 `ebs` (Evidential Bayesian Semantic Mapping) 方法或 `dempster` 方法。

```bash
# dataset 对应 config/datasets/ 下的文件名
# method 对应 config/methods/ 下的文件名
# result_name 是输出地图的路径和前缀
mkdir -p ~/deployTest

roslaunch evsemmap mapping.launch \
    dataset:=deploy_rellisv3_4_1-30 \
    method:=ebs \
    result_name:=/home/xzy/deployTest/rellis_map
```