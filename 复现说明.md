
### 数据集修改
`EvSemSeg/datasets/loader_rellis.py`下
~~
```python
# LBL_POSTFIX = 'pylon_camera_node_label_color'
LBL_POSTFIX = 'pylon_camera_node_label_id'
```
~~
回退，上面的修改是错误的。`pylon_camera_node_label_id`子文件和`pylon_camera_node_label_color`根本不是一个东西。

## 路径修改

### 1. 本地ubuntu

`EvSemSeg/datasets/loader_rellis.py`修改
```python
# RELLIS_ROOT = '/data/Rellis-3D'
RELLIS_ROOT = '/home/xzy/datasets/Rellis-3D'
```

但是目前来看，需要24GB显存才能训练，而且需要加载resnet50的预训练权重。

### 2. autodl服务器

配置git账户
```sh
git config user.name "xzy2022"
git config user.email "2889354227@qq.com"

git config --unset user.name
git config --unset user.email
```

解压数据集
```sh
ls /root/autodl-fs
# 00001.7z.001  00001.7z.002

# apt update && apt install p7zip-full -y

7z x /root/autodl-fs/00001.7z.001 -o/root/datasets/Rellis-3D
# ~/datasets/Rellis-3D
```

`EvSemSeg/datasets/loader_rellis.py`修改
```python
# RELLIS_ROOT = '/data/Rellis-3D'
RELLIS_ROOT = '/root/datasets/Rellis-3D'
RELLIS_ROOT = '/root/autodl-tmp/Rellis-3D'
# /root/autodl-tmp 实例关机数据不会丢失，可存放读写IO要求高的数据。但不会随保存镜像一起保存
```

安装依赖
```sh
pip install  pandas
pip install opencv-python-headless==4.5.5.64 -i https://mirrors.aliyun.com/pypi/simple/
```

修改小规模数据集，`EvSemSeg/datasets/loader_rellis.py`
```python
	# "-4": ['00000', '00001', '00002', '00003'],
	"-4": ['00001'],
```

可视化训练曲线
```sh
tensorboard --logdir EvSemSeg/logs_tb/ --host 0.0.0.0 --port 6006
```



## 加载预训练权重


下载预训练权重，如果网络不佳可以从百度网盘获取。
```sh
mkdir pretrained/
cd pretrained/
wget https://download.pytorch.org/models/resnet50-0676ba61.pth
```

运行`scripts/setup_weights.py`以测试预训练的resnet50加载成功。

修改`EvSemSeg/models/unc_seg_models.py`和`EvSemSeg/models/seg_models.py`的`res50`指定预训练模型地址。

## 修改batch_size
修改`EvSemSeg/execute_params.py`的`rellisv3_train`变量：
    batchsize=6
    CUDA_VISIBLE_DEVICES=0
DeeplabV3 里 ASPP 的 全局平均池化分支要求batchsize>=2，所以还得修改。

单卡batch=6时2080 Ti大概是19G显存。
对于双卡2080 Ti，batch=12比较好。
对于单卡4090，batch=8比较极限（23373MiB /  24564MiB）。

## 执行训练

```sh
cd EvSemSeg/
python3 execute_params.py --mode ex-train
```

### 其它选项

`EvSemSeg/execute_params.py`的`rellisv3_train`可以根据参数实现下面功能
```python
# -- load指向你要恢复的 checkpoint，例如
# --load ./ckpts/rellisv3_edl_train-4_temp/50.pth
# --load \'$NONE$\'  表示重新训练
# --save_freq 1 表示每个epoch都保存权重，否则每10轮保存一次（追加而非覆盖）
```
